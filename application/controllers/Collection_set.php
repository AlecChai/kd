<?php/** * Created by PhpStorm. * User:  我是一颗菜 * Date: 2018/6/8 * Time: 9:49 */class Collection_set extends MY_Controller{    public function __construct()    {        parent::__construct();    }        public function index()    {        //获取类别数据                            $where=[];              $posts=$this->input->post(NULL,true);              //var_dump($posts);      if(element('category_name',$posts) !=''){          $where['b.name_cn'] = trim($posts['category_name']);      }      if(element('enabled',$posts) != ''){          $where['enabled'] = $posts['enabled'];      }           if(element('currentPage',$posts) !=''){           $currentPage=$posts['currentPage'];       }       if(element('pageSize',$posts) !=''){           $pageSize=$posts['pageSize'];       }       $page=($currentPage-1)*$pageSize;             $all  =$this->db->select('a.id id,a.category_id,a.category_name_cn,a.category_code,a.collection_url,a.collection_page,a.enabled,b.name_cn as category_name,b.id as cid')->where($where)->from('t_collection_set as a')->join('t_category as b','a.category_id = b.id','left')->get()->result_array();       $result=$this->db->select('a.id id,a.category_id,a.category_name_cn,a.category_code,a.collection_url,a.collection_page,a.enabled,b.name_cn as category_name,b.id as cid')->where($where)->from('t_collection_set as a')->join('t_category as b','a.category_id = b.id','left')->order_by('a.create_time','desc')->limit($pageSize,$page)->get()->result_array();              $data['data']=$result;       $data['total']=count($all);       $data['query'] = str_replace("\n", "\t", $this->db->last_query());              echo json_encode($data);          }        public function add()    {                               if(!$_POST) return;        $row=$this->db->select('id,code')->where('id',$_POST['s_id'])->get('t_category')->row();        extract($_POST);        $cat_name = trim($category_name);                        $data=array(            'category_id'       => $row->id,            'collection_url'    => $collection_url,            'category_name_cn'  => $cat_name,            'category_code'     => $row->code,            'collection_page'   => empty($collection_page)?30:$collection_page,            'enabled'           => $enabled,            'create_time'       => date("Y-m-d H:i:s",time()),            'created_man'       => $_SESSION['id'],            'created_man_name'  => $_SESSION['username']                    );        $this->db->insert('t_collection_set',$data);        re_json([],0,'添加成功');            }        public function edit()    {        if(!$_POST) return;                extract($_POST);        if(empty($s_id_2)){            $cat_id = intval($category_id);            $row    = $this->db->select('id,name_cn,code')->where('id',$cat_id)->get('t_category')->row();        }else{            $id     =intval($s_id_2);            $row    =$this->db->select('id,name_cn,code')->where('id',$s_id_2)->get('t_category')->row();        }                $data=array(                'category_id'       =>$row->id,                'category_name_cn'  =>$row->name_cn,                'category_code'     =>$row->code,                'collection_url'    =>$collection_url,                'collection_page'   =>intval($collection_page),                'enabled'           =>$enabled,                'modify_time'       =>date('Y-m-d H:i:s',time()),                'modified_man'      =>$_SESSION['id']        );                $this->db->where('id',$id)->update('t_collection_set',$data);        re_json([],0,'修改成功');            }        public function  delete()    {        //只有处于禁用状态时才可以删除        $id  = intval($this->input->get('id'));        $res = $this->db->select('enabled')->where('id',$id)->get('t_collection_set')->row();        if(intval($res->enabled)===2){               $this->db->where('id',$id)->delete('t_collection_set');        }        re_json([],0,'删除成功');            }            public function  get_select_cat(){        $gets      = $this->input->get(NULL,TRUE);                $queryData = strtoupper($gets['queryData']);                       $wh=[];        if(!empty($queryData)){            $wh["name_cn like '$queryData%' or cat_1 like '$queryData%'  or cat_2 like '$queryData%' or cat_3 like '$queryData%' or cat_4 like '$queryData%' "] = null;        }                if(!empty($queryData)){            $name_cn = $this->db->select('id,name_cn,cat_2,cat_3,cat_4')->where($wh)->limit(7)->get('t_category')->result_array();                        $data['data'] =$name_cn;            echo   json_encode($data);        }else{            return false;        }                   }}