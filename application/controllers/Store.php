<?php/** * Created by PhpStorm. * User:  我是一颗菜 * Date: 2018/6/5 * Time: 19:23 */class Store extends MY_Controller{    public function __construct()    {        parent::__construct();    }        public function index()    {       $owners =  $this->db->select('id,username')->where(array('status'=>1))->get('t_user')->result_array();       $brandData = $this->db->select('id,brand_name')->get('t_brand')->result_array();       $posts  =  $this->input->post(NULL,true);       $where=array();       if(element('store_code',$posts) != ''){           $where['store_code'] = element('store_code',$posts);                  }       if(element('owner',$posts)!=''){            $ownerID = (int)$_POST['owner'];            $where["find_in_set('$ownerID',a.owner) !="] = 0;               }        if(element('store_email',$posts) != ''){            $where['store_email'] = element('store_email',$posts);                }                     $currentPage = element('currentPage', $_POST, 1);       $pageSize = element('pageSize', $_POST, 10);       //$row_num = element('row_num',$posts);       $page = ($currentPage - 1) * $pageSize;       $table ='t_store a';       $join=array();       $join []=array('t_user u','a.created_id = u.id','left');       $fields="a.id,a.store_code,a.owner,a.brand_id as brand,u.username,a.store_email,a.store_passw";       $all=$this->getJoinData($table,$join,$where,$fields,'a.create_time','',0,0);       $total=count($all);       $result=$this->getJoinData($table,$join,$where,$fields,'a.create_time','',$page,$pageSize);              $datas=array();       //负责人       foreach($result as $v)       {            $owner_ids=explode(',',$v['owner']);            $owner_name=array();            foreach($owner_ids as $id){                $owner_res=$this->db->select('username')->where_in('id',$id)->get('t_user')->row_array();                $owner_name[]=$owner_res['username'];            }            $v['owner']=implode(',',$owner_name);            $datas[]=$v;       }                   //品牌        foreach($datas as &$v2)        {            $b_id = intval($v2['brand']);            $brand_res = $this->db->select('brand_name')->where_in('id', $b_id)->get('t_brand')->row_array();            $v2['brand'] = $brand_res['brand_name'];        }                     $data['ownersData']=$owners;        $data['data'] =$datas;        $data['total'] = intval($total);        $data['brandData']=$brandData;       // $data['data']=$data;        //$data['total']=$count;        echo json_encode($data);                   }         public function add(){        if(!$_POST) return;               extract($_POST);        $data=array(            'store_code'=> $store_code,            'owner'     =>implode(',',$owner),            'create_time'=>date('Y-m-d H:i:s'),            'created_id' =>$_SESSION['id'],            'store_email'=>$store_email,            'brand_id'   =>intval($brand),                        'store_passw'=>$store_passw        );               $this->db->insert("t_store",$data);       re_json([],0,'添加成功');        }      public function edit_before()   {       //因为多选框 所以修改数据格式为数组        $id=intval($this->input->post('id'));        $row=$this->db->select('owner')->where('id',$id)->get('t_store')->row_array();        $owner_ids=$row['owner'];        if(strpos($owner_ids,',') !==false){            $ids=explode(',',$owner_ids);        }else{            $ids=$owner_ids;        }        $updateData=$this->db->select('id')->where_in('id',$ids)->get('t_user')->result_array();        $arr=[];       foreach($updateData as $v){        $arr[]=$v['id'];       }        $data['data']=$arr;        echo json_encode($data);                                 }      public function edit(){        if(!$_POST) return;        extract($_POST);        $data=[];        $wh  =[];        if(count($owner)>1){            $data['owner'] = implode(',',$owner);        }elseif(count($owner) == 1){            $data['owner'] = $owner[0];        }                if($id) {            $wh['id'] = $id;        }                if($username){            $res=$this->db->select('id')->where('username',$username)->get('t_user')->row();            $data['created_id'] = $res->id;        }        if($store_code){            $data['store_code'] = trim($store_code);        }       if($store_email){           $data['store_email'] = trim($store_email);       }       if($store_passw){           $data['store_passw'] = trim($store_passw);       }       if($brand){            $data['brand_id']   = trim($brand);       }                                $this->db->where($wh)->update('t_store',$data);        re_json([],0,'修改成功');                                 }        public function getJoinData($table="", $join='', $where="", $fields="", $order='', $groupby='', $first_row='0', $num='0',$array_in=array()){        $table = $table==''?$this->table:$table;                if(is_array($join)){            foreach($join as $key=>$value){                if($value[2]){                    $this->db->join($value[0], $value[1],$value[2]);                }else{                    $this->db->join($value[0], $value[1]);                }            }        }        if(!empty($array_in)){            foreach($array_in as $keyin=>$inkay){                $this->db->where_in($keyin, $inkay);            }        }        if($where){            $this->setWhere($where);        }        if($fields){            $this->db->select($fields);        }                if($order){            $this->db->order_by($order,'desc');        }                if($groupby){            $this->db->group_by($groupby);        }                if($first_row>0){            $this->db->limit($num,$first_row);        }elseif($num > 0){            $this->db->limit($num);        }                $data = $this->db->get($table)->result_array();        //echo $this->db->last_query();                return $data;    }        public function getSingle($getwhere="",$table=''){        $table = $table==''?$this->table:$table;        if($getwhere){            $this->setWhere($getwhere);        }        $row = $this->db->get($table)->row_array();        return $row;    }        function setWhere($getwhere){        if(is_array($getwhere)){            foreach($getwhere as $key=>$where){                if($key=='findinset'){                                        $this->db->where("1","1 AND FIND_IN_SET($where)",FALSE);                    continue;                }                if(is_array($where)){                    if($key == 'or'){                        $this->db->or_where($where[0],$where[1]);                    }                    elseif($key == 'like') {                        foreach($where as $k => $v) {                            $this->db->like($k, $v, 'both');                        }                    }                    elseif($key == 'not in') {                        $this->db->where_not_in($where[0], $where[1]);                    }                    else{                        $this->db->where_in($key, $where);                    }                }elseif($key == 'str'){                    $this->db->where($where);                }else{                    $this->db->where($key,$where);                }            }        } else {            $this->db->where($getwhere);        }    }}